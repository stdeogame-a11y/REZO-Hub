-- REZO HUB - Chest System
local ChestSystem = {}
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local RezoHub = nil

function ChestSystem:Initialize(config)
    self.Config = config
    RezoHub = _G.RezoHub or require(script.Parent.MainScript)
    self.Active = false
    self.CurrentChests = {}
    
    print("âœ… Chest System inicializado")
end

function ChestSystem:Update()
    if not self.Config.AutoCollectChests or not self.Active then
        return
    end
    
    self:ScanForChests()
    self:CollectNearestChest()
end

function ChestSystem:ScanForChests()
    self.CurrentChests = {}
    
    -- Buscar cofres en ubicaciones comunes
    local chestLocations = {
        workspace:FindFirstChild("Chests"),
        workspace:FindFirstChild("Chest"),
        workspace:FindFirstChild("TreasureChest")
    }
    
    for _, location in ipairs(chestLocations) do
        if location then
            for _, chest in ipairs(location:GetChildren()) do
                if chest:IsA("Model") or chest:IsA("Part") then
                    table.insert(self.CurrentChests, chest)
                end
            end
        end
    end
end

function ChestSystem:CollectNearestChest()
    local character = player.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoid or not rootPart then return end
    
    local nearestChest = nil
    local shortestDistance = self.Config.ChestRange
    
    for _, chest in ipairs(self.CurrentChests) do
        local chestPos = chest:IsA("Model") and chest:GetPivot().Position or chest.Position
        local distance = (chestPos - rootPart.Position).Magnitude
        
        if distance < shortestDistance then
            shortestDistance = distance
            nearestChest = chest
        end
    end
    
    if nearestChest then
        local targetPos = nearestChest:IsA("Model") and nearestChest:GetPivot().Position or nearestChest.Position
        humanoid:MoveTo(targetPos)
        
        if shortestDistance < 8 then
            if nearestChest:FindFirstChild("ClickDetector") then
                fireclickdetector(nearestChest.ClickDetector)
                if self.Config.DebugMode then
                    print("ðŸ“¦ Cofre abierto: " .. nearestChest.Name)
                end
            end
        end
    end
end

function ChestSystem:StartCollecting()
    self.Active = true
    print("ðŸ—ºï¸ Auto Cofres ACTIVADO")
end

function ChestSystem:StopCollecting()
    self.Active = false
    print("ðŸ—ºï¸ Auto Cofres DESACTIVADO")
end

function ChestSystem:GetChestCount()
    return #self.CurrentChests
end

return ChestSystem
